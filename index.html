<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f0f0f0;
    }

    #container {
      max-width: 800px;
      margin: 0 auto;
    }

    /* Fullscreen button row */
    #fs {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }
    #fs button {
      flex: 1;
      height: 50px;
      font-size: 16px;
      cursor: pointer;
    }

    /* Font selector row */
    #fonts {
      width: 100%;
      height: 40px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    textarea {
      width: 100%;
      height: 400px;
      font-size: 16px;
      padding: 10px;
      resize: vertical;
    }

    #editor {
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="fs">
      <button id="fsbtn">Enter Fullscreen</button>
      <button onclick="document.exitFullscreen()">Exit Fullscreen</button>
    </div>

    <!-- font selector -->
    <select id="fonts">
      <option value="Comic Sans MS">Comic Sans MS</option>
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Courier New">Courier New</option>
      <option value="monospace">Monospace</option>
    </select>

    <textarea id="editor" placeholder="Type Here..."></textarea>
  </div>

  <!-- Fullscreen logic -->
  <script>
    const fsBtn = document.getElementById("fsbtn");
    fsBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch((err) => {
          window.open("", "_blank");
          window.close();
        });
      }
    });
  </script>

  <!-- Yjs collaboration + persistence -->
  <script type="module">
    import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.8.13/dist/yjs.mjs';
    import { WebrtcProvider } from 'https://cdn.jsdelivr.net/npm/y-webrtc@10.0.7/dist/y-webrtc.mjs';
    import { IndexeddbPersistence } from 'https://cdn.jsdelivr.net/npm/y-indexeddb@1.2.4/dist/y-indexeddb.mjs';
    import { yTextAreaBinding } from 'https://cdn.jsdelivr.net/npm/yjs-utils@0.0.4/dist/yjs-utils.min.js';

    // Get or create document ID
    let docId = location.hash.slice(1);
    if (!docId) {
      docId = Math.random().toString(36).slice(2, 10);
      location.hash = docId;
    }

    const doc = new Y.Doc();
    const ytext = doc.getText('shared-text');
    const ystyle = doc.getMap("style");

    const persistence = new IndexeddbPersistence(docId, doc);
    const provider = new WebrtcProvider(docId, doc);

    const textarea = document.getElementById('editor');
    const fontel = document.getElementById('fonts');

    // --- Text Binding (auto-sync between Yjs & textarea) ---
    yTextAreaBinding(ytext, textarea);

    // Load existing text from IndexedDB
    persistence.whenSynced.then(() => {
      console.log('Document loaded from IndexedDB!');
    });

    // --- Font Sync ---
    // Apply saved font when joining
    const savedFont = ystyle.get("fontFamily") || fontel.value;
    textarea.style.fontFamily = savedFont;
    fontel.value = savedFont;

    // Update font if another peer changes it
    ystyle.observe(() => {
      const font = ystyle.get("fontFamily");
      if (font) {
        textarea.style.fontFamily = font;
        fontel.value = font;
      }
    });

    // Update shared font when user selects a new font
    fontel.addEventListener("change", () => {
      const font = fontel.value;
      textarea.style.fontFamily = font;
      ystyle.set("fontFamily", font);
    });
  </script>
</body>
</html>
